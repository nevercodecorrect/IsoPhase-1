# CVE-2020-5311
Pillow

crafted sgi image will cause buffer overflow in libImaging/SgiRleDecode.c

Vulnerable Code
```C
//static int expandrow(UINT8* dest, UINT8* src, int n, int z)
static int expandrow(UINT8* dest, UINT8* src, int n, int z, int xsize){
// xsize to validate the input size
    UINT8 pixel, count;
    for (;n > 0; n--)
    {
        pixel = *src++;
        count = pixel & RLE_MAX_RUN;
        if (!count)
            return count;
        if (count > xsize) {
            return -1; // if count is larger than the xsize, abort
        }
    }    
}


//static int expandrow2(UINT8* dest, const UINT8* src, int n, int z)
static int expandrow2(UINT8* dest, const UINT8* src, int n, int z, int xsize){
// xsize to validate the input size
    UINT8 pixel, count;
    for (;n > 0; n--)
    {
        pixel = src[1];
        src+=2;
        if (n == 1 && pixel != 0)
            return n;
        count = pixel & RLE_MAX_RUN;
        if (!count)
            return count;
        if (count > xsize) { // if count is larger than the xsize, abort
            return -1;
        }
    }
}
int ImagingSgiRleDecode(Imaging im, ImagingCodecState state,UINT8* buf, Py_ssize_t bytes){
    int status;
    status = expandrow(&state->buffer[c->channo], &ptr[c->rleoffset], c->rlelength, im->bands, im->xsize);
    status = expandrow2(&state->buffer[c->channo * 2], &ptr[c->rleoffset], c->rlelength, im->bands, im->xsize);
    if (status == -1) {// add check ob the return value of vulnerable function
        state->errcode = IMAGING_CODEC_OVERRUN;
        return -1;
    } else if (status == 1) {
        goto sgi_finish_decode;
    }
}

```